@using BlindBoxShop.Shared.DataTransferObject.Order
@using BlindBoxShop.Shared.DataTransferObject.OrderDetail
@using BlindBoxShop.Shared.Enum
@using MudBlazor
@using System.Threading.Tasks
@using System
@using System.Linq
@using BlindBoxShop.Service.Contract
@using BlindBoxShop.Application.Components.Dialogs
@using BlindBoxShop.Shared.DataTransferObject.BlindBox

@inject ISnackbar Snackbar
@inject IServiceManager ServiceManager
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService

<MudDialog>
    <DialogContent>
        @if (OrderWithDetails == null)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        }
        else
        {
            <div class="py-2">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <MudText Typo="Typo.h6">Order #@OrderWithDetails.Order.Id.ToString().Substring(0, 8)</MudText>
                        <MudText Typo="Typo.body2" Class="text-gray-500">@OrderWithDetails.Order.CreatedAt.ToString("dd MMMM yyyy, HH:mm")</MudText>
                    </div>
                    <MudBadge Color="@GetOrderStatusColor(OrderWithDetails.Order.Status)" Overlap="true" Class="mx-6 my-4">
                        @OrderWithDetails.Order.Status.ToString()
                    </MudBadge>
                </div>
                
                <MudDivider Class="my-4" />
                
                <MudText Typo="Typo.subtitle1" Class="mb-2">Items</MudText>
                <div>
                    @foreach (var item in OrderWithDetails.OrderDetails)
                    {
                        <div class="flex justify-between w-full items-center p-2 border-b">
                            <div class="flex items-center">
                                <div class="product-image-container flex-shrink-0 mr-3 border border-gray-200">
                                    @if (!string.IsNullOrEmpty(item.ImageUrl) || item.BlindBoxItemId.HasValue)
                                    {
                                        <img src="@(GetImageUrl(item).Result)" alt="@(GetDisplayName(item))" 
                                             class="h-full w-full object-contain" 
                                             @onclick="async () => await OpenImagePreview(await GetImageUrl(item))" />
                                        <div class="image-overlay" @onclick="async () => await OpenImagePreview(await GetImageUrl(item))">
                                            <MudIcon Icon="@Icons.Material.Filled.ZoomIn" Size="Size.Small" Color="Color.Surface" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="w-full h-full bg-gray-100 flex items-center justify-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Spa" Size="Size.Small" Color="Color.Primary" />
                                        </div>
                                    }
                                </div>
                                <div>
                                    @if (_itemsLoading.ContainsKey(item.Id) && _itemsLoading[item.Id])
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    }
                                    else
                                    {
                                        <div class="font-medium">@(GetDisplayName(item))</div>
                                        @if (_blindBoxItems.ContainsKey(item.Id) && _blindBoxItems[item.Id] != null)
                                        {
                                            <div class="flex items-center mt-1">
                                                <MudChip T="string" Size="Size.Small" 
                                                         Color="@GetItemRarityColor(_blindBoxItems[item.Id].Rarity)" 
                                                         Class="mr-1 px-2 py-0">
                                                    @GetRarityText(_blindBoxItems[item.Id].Rarity)
                                                </MudChip>
                                                @if (_blindBoxItems[item.Id].IsSecret)
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.Star" 
                                                          Size="Size.Small" 
                                                          Color="Color.Warning" 
                                                          Class="ml-1" />
                                                }
                                            </div>
                                        }
                                        <div class="text-xs text-gray-500">Qty: @item.Quantity</div>
                                    }
                                </div>
                            </div>
                            <MudText Typo="Typo.body2">@FormatPrice(item.Price)</MudText>
                        </div>
                    }
                </div>
                
                <MudDivider Class="my-4" />
                
                <div class="flex justify-between items-center mb-2">
                    <MudText Typo="Typo.body1">Subtotal</MudText>
                    <MudText Typo="Typo.body2">@FormatPrice(OrderWithDetails.Order.SubTotal)</MudText>
                </div>
                
                <div class="flex justify-between items-center mb-2">
                    <MudText Typo="Typo.body1">Shipping</MudText>
                    <MudText Typo="Typo.body2">@FormatPrice(20000)</MudText>
                </div>
                
                <div class="flex justify-between items-center mb-2 font-bold">
                    <MudText Typo="Typo.h6">Total</MudText>
                    <MudText Typo="Typo.h6" Color="Color.Primary">@FormatPrice(OrderWithDetails.Order.Total)</MudText>
                </div>
                
                <MudDivider Class="my-4" />
                
                <MudText Typo="Typo.subtitle1" Class="mb-2">Shipping Information</MudText>
                <div class="p-3 bg-gray-50 rounded-lg mb-3">
                    <div class="mb-1"><span class="font-semibold">Name:</span> @OrderWithDetails.Order.CustomerName</div>
                    <div class="mb-1"><span class="font-semibold">Phone:</span> @Phone</div>
                    <div><span class="font-semibold">Address:</span> @OrderWithDetails.Order.Address, @OrderWithDetails.Order.Wards, @OrderWithDetails.Order.Province</div>
                </div>
                
                @if (OrderWithDetails.Order.Status == OrderStatus.Pending && OrderWithDetails.Order.PaymentMethod != PaymentMethod.Cash)
                {
                    <MudAlert Severity="Severity.Info" Class="my-4">
                        <div class="flex items-center mb-1">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                            <MudText Typo="Typo.body1" Class="font-semibold">Payment Pending</MudText>
                        </div>
                        <MudText Typo="Typo.body2">
                            This order is awaiting payment confirmation. Once payment is received, your order will be processed.
                        </MudText>
                    </MudAlert>
                }
                
                @if (OrderWithDetails.Order.Status == OrderStatus.Pending)
                {
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Error" 
                               OnClick="CancelOrder"
                               FullWidth="true"
                               Class="mt-4">
                        Cancel Order
                    </MudButton>
                }
            </div>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Secondary">Close</MudButton>
    </DialogActions>
</MudDialog>

<!-- Image Preview Overlay -->
<MudOverlay @bind-Visible="_imagePreviewVisible" DarkBackground="true" ZIndex="999" OnClick="CloseImagePreview">
    <div class="d-flex justify-center align-items-center" style="height: 100vh;" @onclick:preventDefault>
        <div class="position-relative" style="width: 90%; max-width: 800px; max-height: 90vh; overflow: auto;">
            <MudCard Class="pa-4 position-relative" Style="background-color: rgba(0,0,0,0.8);">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Surface">Image Preview</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Surface" OnClick="CloseImagePreview" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="d-flex flex-column align-center justify-center">
                    <div class="result-image-container @($"{(_isZoomed ? "zoomed" : "")}")">
                        <MudImage Src="@_selectedImage" 
                               Alt="Image Preview"
                               Class="result-image rounded-lg" 
                               ObjectFit="ObjectFit.Contain"
                               @onclick="ToggleZoom" />
                    </div>
                </MudCardContent>
            </MudCard>
        </div>
    </div>
</MudOverlay>

<style>
    .product-image-container {
        width: 48px;
        height: 48px;
        overflow: hidden;
        border-radius: 4px;
        position: relative;
        cursor: pointer;
    }
    
    .product-image-container:hover .image-overlay {
        opacity: 1;
    }
    
    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .result-image-container {
        width: 280px;
        height: 280px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: transparent;
        border-radius: 8px;
        transition: transform 0.3s ease;
        cursor: zoom-in;
    }
    
    .result-image-container.zoomed {
        transform: scale(1.5);
        cursor: zoom-out;
    }
    
    .result-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        width: 100%;
        height: 100%;
    }
</style>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }
    
    [Parameter] public OrderWithDetailsDto OrderWithDetails { get; set; }
    
    [Parameter] public string Phone { get; set; } = "N/A";
    
    [Parameter] public Dictionary<Guid, BlindBoxItemDto> BlindBoxItems { get; set; } = new Dictionary<Guid, BlindBoxItemDto>();
    
    private bool _imagePreviewVisible = false;
    private string _selectedImage = string.Empty;
    private bool _isZoomed = false;
    
    // Dictionary to track loading state
    private Dictionary<Guid, bool> _itemsLoading = new Dictionary<Guid, bool>();
    
    // Copy local reference to service-loaded BlindBoxItems
    private Dictionary<Guid, BlindBoxItemDto> _blindBoxItems = new Dictionary<Guid, BlindBoxItemDto>();
    
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        if (OrderWithDetails != null)
        {
            // Initialize loading state for all items
            foreach (var detail in OrderWithDetails.OrderDetails)
            {
                _itemsLoading[detail.Id] = false;
            }
            
            // Copy BlindBoxItems from parent if provided
            if (BlindBoxItems != null && BlindBoxItems.Count > 0)
            {
                _blindBoxItems = new Dictionary<Guid, BlindBoxItemDto>(BlindBoxItems);
                
                // Update image URLs for order details that have BlindBoxItems
                foreach (var detail in OrderWithDetails.OrderDetails)
                {
                    if (detail.BlindBoxItemId.HasValue && 
                        _blindBoxItems.ContainsKey(detail.Id) && 
                        _blindBoxItems[detail.Id] != null && 
                        string.IsNullOrEmpty(detail.ImageUrl) &&
                        !string.IsNullOrEmpty(_blindBoxItems[detail.Id].ImageUrl))
                    {
                        // Ensure URL format is correct
                        var imageUrl = _blindBoxItems[detail.Id].ImageUrl;
                        if (!imageUrl.StartsWith("http://") && !imageUrl.StartsWith("https://") && !imageUrl.StartsWith("/"))
                        {
                            imageUrl = "/" + imageUrl;
                        }
                        
                        // Update the image URL in the OrderDetail
                        detail.ImageUrl = imageUrl;
                    }
                }
            }
            else
            {
                // Fallback to loading BlindBoxItems if not provided by the parent
                foreach (var detail in OrderWithDetails.OrderDetails)
                {
                    if (detail.BlindBoxItemId.HasValue)
                    {
                        await LoadBlindBoxItem(detail.Id, detail.BlindBoxItemId.Value);
                    }
                }
            }
        }
    }
    
    // Fallback method if items weren't loaded by the parent component
    private async Task LoadBlindBoxItem(Guid orderDetailId, Guid blindBoxItemId)
    {
        try
        {
            _itemsLoading[orderDetailId] = true;
            StateHasChanged();
            
            using var blindBoxItemService = ServiceManager.BlindBoxItemService;
            var result = await blindBoxItemService.GetBlindBoxItemByIdAsync(blindBoxItemId, false);
            
            if (result.IsSuccess && result.Value != null)
            {
                _blindBoxItems[orderDetailId] = result.Value;
                
                // If the item has an image URL but our OrderDetail doesn't, update it
                var orderDetail = OrderWithDetails.OrderDetails.FirstOrDefault(od => od.Id == orderDetailId);
                if (orderDetail != null && string.IsNullOrEmpty(orderDetail.ImageUrl) && !string.IsNullOrEmpty(result.Value.ImageUrl))
                {
                    // Ensure URL format is correct
                    var imageUrl = result.Value.ImageUrl;
                    if (!imageUrl.StartsWith("http://") && !imageUrl.StartsWith("https://") && !imageUrl.StartsWith("/"))
                    {
                        imageUrl = "/" + imageUrl;
                    }
                    
                    // Update the image URL in the OrderDetail
                    orderDetail.ImageUrl = imageUrl;
                }
            }
            else
            {
                Console.WriteLine($"Failed to load BlindBoxItem {blindBoxItemId}: {result.Errors?.FirstOrDefault()?.Description}");
                _blindBoxItems[orderDetailId] = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading BlindBoxItem: {ex.Message}");
            _blindBoxItems[orderDetailId] = null;
        }
        finally
        {
            _itemsLoading[orderDetailId] = false;
            StateHasChanged();
        }
    }
    
    private string GetDisplayName(OrderDetailDto detail)
    {
        // If this detail has a BlindBoxItem, use its name instead
        if (detail.BlindBoxItemId.HasValue && _blindBoxItems.ContainsKey(detail.Id) && _blindBoxItems[detail.Id] != null)
        {
            return _blindBoxItems[detail.Id].Name;
        }
        
        // Otherwise use the BlindBox name
        return detail.BlindBoxName;
    }
    
    private string FormatPrice(decimal price)
    {
        return $"{price:N0} ₫";
    }
    
    private MudBlazor.Color GetOrderStatusColor(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Processing => Color.Info,
            OrderStatus.Delivered => Color.Success,
            OrderStatus.Cancelled => Color.Error,
            OrderStatus.Pending => Color.Warning,
            _ => Color.Default
        };
    }
    
    private MudBlazor.Color GetItemRarityColor(int rarity)
    {
        return rarity switch
        {
            0 => Color.Success,  // Common
            1 => Color.Info,     // Uncommon
            2 => Color.Warning,  // Rare
            3 => Color.Error,    // Epic
            4 => Color.Secondary, // Legendary
            _ => Color.Default
        };
    }
    
    private string GetRarityText(int rarity)
    {
        return rarity switch
        {
            0 => "Common",
            1 => "Uncommon",
            2 => "Rare",
            3 => "Epic",
            4 => "Legendary",
            _ => "Unknown"
        };
    }
    
    private async Task OpenImagePreview(string imageUrl)
    {
        if (!string.IsNullOrEmpty(imageUrl))
        {
            _selectedImage = imageUrl;
            _isZoomed = false;
            _imagePreviewVisible = true;
            StateHasChanged();
        }
    }
    
    private void CloseImagePreview()
    {
        _imagePreviewVisible = false;
        _isZoomed = false;
        StateHasChanged();
    }
    
    private void ToggleZoom()
    {
        _isZoomed = !_isZoomed;
        StateHasChanged();
    }
    
    // Simple method for closing dialog
    private void Cancel() => MudDialog.Cancel();
    
    private async Task CancelOrder()
    {
        var parameters = new DialogParameters
        {
            ["OrderId"] = OrderWithDetails.Order.Id,
            ["Content"] = "Bạn có chắc chắn muốn hủy đơn hàng này không?"
        };
        
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraSmall
        };
        
        var dialog = await DialogService.ShowAsync<ConfirmCancelOrderDialog>("Xác nhận hủy đơn hàng", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
    }
    
    private async Task<string> GetImageUrl(OrderDetailDto detail)
    {
        if (detail == null)
        {
            return "/images/box-placeholder.jpg";
        }
        
        // If detail has a BlindBoxItemId and we haven't loaded it yet, load it first
        if (detail.BlindBoxItemId.HasValue && 
            (!_blindBoxItems.ContainsKey(detail.Id) || _blindBoxItems[detail.Id] == null))
        {
            await LoadBlindBoxItem(detail.Id, detail.BlindBoxItemId.Value);
        }
        
        // Use BlindBoxItem's image if available
        if (detail.BlindBoxItemId.HasValue && 
            _blindBoxItems.ContainsKey(detail.Id) && 
            _blindBoxItems[detail.Id] != null && 
            !string.IsNullOrEmpty(_blindBoxItems[detail.Id].ImageUrl))
        {
            var imageUrl = _blindBoxItems[detail.Id].ImageUrl;
            if (!imageUrl.StartsWith("http://") && !imageUrl.StartsWith("https://") && !imageUrl.StartsWith("/"))
            {
                imageUrl = "/" + imageUrl;
            }
            return imageUrl;
        }
        
        // Fallback to the original detail image URL
        if (!string.IsNullOrEmpty(detail.ImageUrl))
        {
            var imageUrl = detail.ImageUrl;
            if (!imageUrl.StartsWith("http://") && !imageUrl.StartsWith("https://") && !imageUrl.StartsWith("/"))
            {
                imageUrl = "/" + imageUrl;
            }
            return imageUrl;
        }
        
        // Default placeholder if no image available
        return "/images/box-placeholder.jpg";
    }
} 