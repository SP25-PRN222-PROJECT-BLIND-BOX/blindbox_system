@page "/order-detail/{OrderId}"
@using System;
@using System.Collections.Generic;
@using System.Linq;
@using BlindBoxShop.Entities.Models;
@using Microsoft.AspNetCore.Identity;
@using Microsoft.AspNetCore.Components.Authorization;

@layout BlindBoxShop.Application.Components.Layout.MainLayout

<PageTitle>Order Detail as Customer</PageTitle>

<div class="container mx-auto py-6 px-4">
    <div class="bg-cyan-50 rounded-lg p-4 mb-6">
        <h1 class="text-xl font-bold text-cyan-800">Order Detail as Customer</h1>
    </div>

    <div class="flex flex-col md:flex-row gap-6">
        <!-- Navigation Sidebar -->
        <div class="w-full md:w-1/4">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium">Navigation</h3>
                </div>
                <div class="p-2">
                    <a href="/my-account" class="flex items-center p-2 rounded-md hover:bg-gray-100 text-gray-700">
                        <MudIcon Icon="@Icons.Material.Outlined.Person" Class="mr-3 text-gray-500" Size="Size.Small" />
                        <span>User info</span>
                    </a>
                    <a href="/order-history" class="flex items-center p-2 rounded-md bg-gray-100 text-cyan-600">
                        <MudIcon Icon="@Icons.Material.Outlined.Receipt" Class="mr-3 text-cyan-600" Size="Size.Small" />
                        <span>Order History</span>
                    </a>
                    <a href="/logout" class="flex items-center p-2 rounded-md hover:bg-gray-100 text-gray-700">
                        <MudIcon Icon="@Icons.Material.Outlined.Logout" Class="mr-3 text-gray-500" Size="Size.Small" />
                        <span>Log-out</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="w-full md:w-3/4">
            @if (_order == null)
            {
                <div class="flex justify-center items-center py-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                </div>
            }
            else
            {
                <!-- Order Detail Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold mb-2">Order Details</h2>
                        <div class="flex flex-wrap items-center text-sm text-gray-500">
                            <span>@_order.OrderDate.ToString("MMMM dd, yyyy")</span>
                            <span class="mx-2">â€¢</span>
                            <span>@(_order.Items?.Count ?? 0) Products</span>
                        </div>
                    </div>
                    <MudButton Variant="Variant.Text" 
                              Color="Color.Primary"
                              Href="/order-history"
                              Class="text-cyan-600 mt-3 md:mt-0">
                        Back to List
                    </MudButton>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Shipping Address -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="uppercase text-gray-500 text-sm font-medium mb-4">SHIPPING ADDRESS</h3>
                        <div class="text-gray-800 font-medium">@_order.CustomerName</div>
                        <div class="text-gray-600 mt-1">@_order.Address</div>
                        
                        <div class="mt-6">
                            <div class="text-xs uppercase text-gray-500 mb-1">EMAIL</div>
                            <div class="text-gray-700">@_order.Email</div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="text-xs uppercase text-gray-500 mb-1">PHONE</div>
                            <div class="text-gray-700">@_order.Phone</div>
                        </div>
                    </div>
                    
                    <!-- Order Summary -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <div class="text-xs uppercase text-gray-500 font-medium">ORDER ID:</div>
                            <div class="text-right font-medium">#@_order.Id</div>
                            
                            <div class="text-xs uppercase text-gray-500 font-medium">PAYMENT METHOD:</div>
                            <div class="text-right">@_order.PaymentMethod</div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex justify-between py-2">
                                <div>Subtotal:</div>
                                <div class="font-medium">@FormatPrice(_order.Subtotal)</div>
                            </div>
                            <div class="flex justify-between py-2">
                                <div>Shipping:</div>
                                <div class="font-medium">@FormatPrice(_order.ShippingCost)</div>
                            </div>
                            <div class="border-t border-gray-200 my-2"></div>
                            <div class="flex justify-between py-2 font-bold text-lg">
                                <div>Total</div>
                                <div class="text-cyan-700">@FormatPrice(_order.Total)</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Status Tracker -->
                @if (_statusSteps != null && _statusSteps.Any())
                {
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                        <div class="relative pt-2">
                            <div class="absolute top-10 left-0 right-0 h-1 bg-gray-200">
                                <div class="h-full bg-green-500" style="width: @_statusProgressPercentage%;"></div>
                            </div>
                            
                            <div class="flex justify-between relative">
                                @foreach (var status in _statusSteps)
                                {
                                    <div class="flex flex-col items-center z-10">
                                        @if (status.IsCompleted)
                                        {
                                            <div class="bg-green-500 text-white w-12 h-12 rounded-full flex items-center justify-center mb-3">
                                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" />
                                            </div>
                                        }
                                        else if (status.IsActive)
                                        {
                                            <div class="bg-cyan-600 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold mb-3">
                                                @status.Step
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="bg-gray-200 text-gray-500 w-12 h-12 rounded-full flex items-center justify-center font-bold mb-3">
                                                @status.Step
                                            </div>
                                        }
                                        <div class="text-center text-sm mt-1 @GetStatusTextClass(status)">@status.Name</div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
                
                <!-- Product List -->
                @if (_order.Items != null && _order.Items.Any())
                {
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
                        <MudTable Items="_order.Items" Hover="true" Breakpoint="Breakpoint.Sm" Class="border-0">
                            <HeaderContent>
                                <MudTh Class="uppercase text-xs font-medium text-gray-500">PRODUCT</MudTh>
                                <MudTh Class="uppercase text-xs font-medium text-gray-500 text-right">PRICE</MudTh>
                                <MudTh Class="uppercase text-xs font-medium text-gray-500 text-center">QUANTITY</MudTh>
                                <MudTh Class="uppercase text-xs font-medium text-gray-500 text-right">SUBTOTAL</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>
                                    <div class="flex items-center">
                                        <img src="@context.ImageUrl" alt="@context.ProductName" class="w-16 h-16 object-cover mr-3 rounded" />
                                        <div>
                                            <div class="font-medium">@context.ProductName</div>
                                        </div>
                                    </div>
                                </MudTd>
                                <MudTd Class="text-right">@FormatPrice(context.Price)</MudTd>
                                <MudTd Class="text-center">x@(context.Quantity)</MudTd>
                                <MudTd Class="text-right font-medium">@FormatPrice(context.Price * context.Quantity)</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </div>
                    
                    @if (_order.Status != "Delivered" && _order.Status != "Cancelled")
                    {
                        <div class="flex justify-end">
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Error"
                                      OnClick="@(() => CancelOrder())"
                                      Class="rounded-md px-6">
                                Cancel order
                            </MudButton>
                        </div>
                    }
                }
            }
        </div>
    </div>
</div> 