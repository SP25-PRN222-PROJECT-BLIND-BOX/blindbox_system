@page "/blindbox/{id}"
@using BlindBoxShop.Service.Contract
@using BlindBoxShop.Shared.Enum

<PageTitle>@(BlindBox?.Name ?? "Chi tiết BlindBox") - BlindBox Shop</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6 px-2 px-sm-4">
    @if (_isLoading)
    {
        <div class="d-flex justify-center my-16">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (BlindBox == null)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="my-8">
            Không tìm thấy Blind Box.
        </MudAlert>
    }
    else
    {
        <div class="d-flex flex-column flex-md-row gap-8">
            <!-- Image Gallery Section -->
            <div class="flex-grow-0" style="width: 100%; max-width: 500px;">
                @if (BlindBox.Probability > 0)
                {
                    <div class="position-relative">
                        <MudChip T="string" Color="Color.Secondary" Size="Size.Large" Class="position-absolute" Style="top: 0; left: 0; z-index: 10;">
                            <MudIcon Icon="@Icons.Material.Filled.Casino" Class="mr-2" />
                            Online Box
                        </MudChip>
                    </div>
                }
                <MudPaper Elevation="2" Class="overflow-hidden rounded-lg mb-4">
                    <MudCarousel TData="string" AutoCycle="true" ShowArrows="true" ShowBullets="true" Style="height: 400px;" 
                                Class="mud-width-full" EnableSwipeGesture="true">
                        @if (_images.Any())
                        {
                            @foreach (var image in _images)
                            {
                                <MudCarouselItem Transition="Transition.Slide">
                                    <div class="d-flex justify-center align-center h-100 position-relative" 
                                         style="cursor: zoom-in;">
                                        <MudImage Src="@image" Alt="@BlindBox.Name" ObjectFit="ObjectFit.Contain"
                                                 Class="rounded-lg" Style="max-height: 380px; max-width: 100%;" 
                                                 Elevation="0" ErrorText="Cannot load image"
                                                 @onclick="@(() => OpenImagePreview(image))" />
                                        <div class="image-overlay" @onclick="@(() => OpenImagePreview(image))">
                                            <MudIcon Icon="@Icons.Material.Filled.ZoomIn" Color="Color.Surface" Size="Size.Large" />
                                        </div>
                                    </div>
                                </MudCarouselItem>
                            }
                        }
                        else
                        {
                            <MudCarouselItem Transition="Transition.Slide">
                                <div class="d-flex justify-center align-center h-100">
                                    <MudImage Src="/images/box-placeholder.jpg" Alt="@BlindBox.Name" 
                                             ObjectFit="ObjectFit.Contain" Class="rounded-lg" 
                                             Style="max-height: 380px; max-width: 100%;" Elevation="0" />
                                </div>
                            </MudCarouselItem>
                        }
                    </MudCarousel>
                </MudPaper>

                <!-- Status Badges Section -->
                <div class="d-flex flex-wrap gap-2 mb-4">
                    <MudChip T="string" Color="@GetRarityColor(BlindBox.Rarity)" Size="Size.Medium" Variant="Variant.Filled">
                        <MudIcon Icon="@Icons.Material.Filled.Diamond" Class="mr-2" />
                        @BlindBox.Rarity.ToString()
                    </MudChip>
                    
                    <MudChip T="string" Color="@(BlindBox.Status == BlindBoxStatus.Available ? Color.Success : Color.Error)" 
                             Size="Size.Medium" Variant="Variant.Filled">
                        <MudIcon Icon="@(BlindBox.Status == BlindBoxStatus.Available ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)" 
                                 Class="mr-2" />
                        @(BlindBox.Status == BlindBoxStatus.Available ? "Còn hàng" : "Hết hàng")
                    </MudChip>
                    
                    @if (IsNewProduct(BlindBox.CreatedAt))
                    {
                        <MudChip T="string" Color="Color.Secondary" Size="Size.Medium" Variant="Variant.Filled">
                            <MudIcon Icon="@Icons.Material.Filled.NewReleases" Class="mr-2" />
                            Mới
                        </MudChip>
                    }
                    
                    @if (BlindBox.Probability > 0)
                    {
                        <MudChip T="string" Color="Color.Tertiary" Size="Size.Medium" Variant="Variant.Filled">
                            <MudIcon Icon="@Icons.Material.Filled.Public" Class="mr-2" />
                            Online Box
                        </MudChip>
                    }
                </div>
                
                @if (BlindBox.Probability > 0 && BlindBox.Items?.Any() == true)
                {
                    <MudPaper Elevation="2" Class="pa-3 mb-4 position-relative" Style="border: 2px dashed var(--mud-palette-secondary); background-color: rgba(103, 58, 183, 0.05);">
                        <MudText Typo="Typo.subtitle1" Class="mb-3 font-weight-bold d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Visibility" Color="Color.Secondary" Class="mr-2" />
                            Các vật phẩm có thể nhận được:
                        </MudText>
                        <div class="d-flex flex-wrap gap-2 justify-center">
                            @foreach (var item in BlindBox.Items)
                            {
                                <div class="position-relative" style="transition: all 0.2s ease-in-out;" >
                                    <MudAvatar Style="width: 70px; height: 70px; border: 2px solid var(--mud-palette-secondary-lighten); box-shadow: 0 2px 8px rgba(0,0,0,0.1); background-color: #f0f0f0;">
                                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                                        {
                                            <div class="position-relative" style="width: 100%; height: 100%;" @onclick:stopPropagation="true">
                                                <MudImage Src="@item.ImageUrl" Style="width: 100%; height: 100%; object-fit: cover;" 
                                                         ObjectFit="ObjectFit.Cover" Loading="true" ErrorText=""
                                                         @onclick="@(() => OpenImagePreview(item.ImageUrl))" />
                                                <div class="item-image-overlay" @onclick="@(() => OpenImagePreview(item.ImageUrl))">
                                                    <MudIcon Icon="@Icons.Material.Filled.ZoomIn" Color="Color.Surface" Size="Size.Small" />
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Image" />
                                        }
                                    </MudAvatar>
                                    <MudTooltip Text="@($"{item.Name} - {GetRarityText(item.Rarity)}")">
                                        <div class="position-absolute" style="bottom: -4px; right: -4px; background: white; border-radius: 50%; padding: 2px;" @onclick="() => OpenItemPreview(item)">
                                            @if (item.IsSecret)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Star" Style="color: gold;" Size="Size.Small" />
                                            }
                                            else
                                            {
                                                <div style="width: 16px; height: 16px; border-radius: 50%;" class="@($"mud-{GetItemRarityColor(item.Rarity).ToString().ToLower()}")"></div>
                                            }
                                        </div>
                                    </MudTooltip>
                                </div>
                            }
                        </div>
                        <div class="position-absolute" style="top: -10px; right: -10px;">
                            <MudIcon Icon="@Icons.Material.Filled.Casino" Color="Color.Secondary" />
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-2 text-center">
                            Mỗi BlindBox chứa một vật phẩm ngẫu nhiên từ bộ sưu tập.
                            <br />Vật phẩm bí mật có tỷ lệ xuất hiện @BlindBox.Probability%!
                        </MudText>
                    </MudPaper>
                }
            </div>

            <!-- Product Info Section -->
            <div class="flex-grow-1">
                <div class="mb-6">
                    <MudText Typo="Typo.h4" Class="mb-2 font-weight-bold">@BlindBox.Name</MudText>
                    
                    <div class="d-flex align-center mb-4">
                        <MudRating ReadOnly="true" SelectedValue="@((int)BlindBox.TotalRatingStar)" Size="Size.Medium" />
                        <MudText Typo="Typo.body2" Class="ml-2">(@BlindBox.TotalRatingStar)</MudText>
                    </div>
                    
                    <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-4 font-weight-bold">
                        @FormatPrice(BlindBox.CurrentPrice)
                    </MudText>
                    
                    <MudText Typo="Typo.body1" Class="mb-6">
                        @BlindBox.Description
                    </MudText>
                    
                    <MudText Typo="Typo.subtitle1" Class="mb-1">
                        <span class="font-weight-medium">Danh mục:</span> @BlindBox.CategoryName
                    </MudText>
                    
                    @if (BlindBox.Probability > 0)
                    {
                        var probabilityValue = (float)BlindBox.Probability;
                        <MudText Typo="Typo.subtitle1" Class="mb-1 d-flex align-center">
                            <span class="font-weight-medium mr-2">Tỷ lệ secret item:</span> 
                            <MudProgressLinear Value="@probabilityValue" Color="Color.Secondary" Class="mx-4" 
                                              Style="width: 150px; height: 10px;" />
                            <span>@(BlindBox.Probability)%</span>
                        </MudText>
                    }
                </div>
                
                <!-- Add to Cart or Try Your Luck Section -->
                <MudPaper Elevation="0" Class="pa-4 rounded-lg mb-6" 
                         Style="@(BlindBox.Probability > 0 ? "background-color: rgba(103, 58, 183, 0.1); border: 1px solid rgba(103, 58, 183, 0.3)" : "background-color: rgba(0,139,139,0.05)")">
                    <div class="d-flex flex-column flex-sm-row gap-4">
                        @if (BlindBox.Probability > 0)
                        {
                            <!-- Only one BlindBox allowed for online boxes -->
                            <div class="w-100 mb-3">
                                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                                    Online BlindBox can only be purchased one at a time
                                </MudAlert>
                            </div>
                            
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary"
                                      FullWidth="true"
                                      Size="Size.Large"
                                      Href="@($"/blindbox-gacha/{BlindBox.Id}")"
                                      StartIcon="@Icons.Material.Filled.Casino"
                                      Class="mt-4 rounded-lg"
                                      Disabled="@(BlindBox.Status != BlindBoxStatus.Available)">
                                Thử Vận May
                            </MudButton>
                        }
                        else
                        {
                            <MudNumericField @bind-Value="_quantity" Min="1" Max="10" Label="Số lượng" Variant="Variant.Filled" Class="flex-grow-0" />
                            
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                                      StartIcon="@Icons.Material.Filled.ShoppingCart" 
                                      Size="Size.Large"
                                      Disabled="@(BlindBox.Status != BlindBoxStatus.Available)"
                                      Class="flex-grow-1" 
                                      OnClick="AddToCart">
                                Thêm vào giỏ hàng
                            </MudButton>
                        }
                    </div>
                </MudPaper>
                
                <!-- Additional Info Tabs -->
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                    <MudTabPanel Text="Thông tin chi tiết">
                        <MudText Typo="Typo.body1">
                            <p>@BlindBox.Description</p>
                            @if (BlindBox.Probability > 0)
                            {
                                <p>
                                    Đây là Online BlindBox với cơ hội nhận được nhiều vật phẩm độc đáo. 
                                    Càng nhiều người mở, tỷ lệ trúng vật phẩm bí mật càng tăng!
                                </p>
                            }
                            else
                            {
                                <p>BlindBox là một loại sản phẩm đồ chơi bí ẩn, nơi bạn không biết chính xác mình sẽ nhận được gì cho đến khi mở hộp.</p>
                                <p>Mỗi BlindBox có thể chứa một trong nhiều nhân vật hoặc đồ vật khác nhau, thường là một phần của bộ sưu tập.</p>
                            }
                        </MudText>
                    </MudTabPanel>
                    
                    <MudTabPanel Text="Đánh giá">
                        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Dense="true" Class="mb-4">
                            Số lượng đánh giá: @BlindBox.TotalRatingStar ⭐
                        </MudAlert>
                        <MudText Typo="Typo.body1">Mua hàng và đăng nhập để đánh giá sản phẩm này.</MudText>
                    </MudTabPanel>
                </MudTabs>
            </div>
        </div>
        
        <!-- Related Products Section -->
        @if (_relatedProducts.Any())
        {
            <div class="mt-12">
                <MudText Typo="Typo.h5" Class="mb-4">Sản phẩm liên quan</MudText>
                
                <MudGrid>
                    @foreach (var product in _relatedProducts)
                    {
                        <MudItem xs="12" sm="6" md="3">
                            <MudPaper Elevation="3" Class="pa-0 h-100 d-flex flex-column rounded-lg overflow-hidden"
                                    Style="transition: all 0.3s ease-in-out;">
                                <div class="position-relative overflow-hidden" style="height: 200px; cursor: pointer;" 
                                    @onclick="() => NavigateToProductDetail(product.Id)">
                                    <MudImage Src="@((_relatedProductImages.ContainsKey(product.Id) ? _relatedProductImages[product.Id] : "/images/box-placeholder.jpg"))" 
                                            Alt="@product.Name" Class="w-100 h-100 object-cover" />
                                    
                                    <div class="position-absolute d-flex gap-1" style="top: 4px; right: 4px;">
                                        <MudChip T="string" Color="@GetRarityColor(product.Rarity)" Size="Size.Small">
                                            @product.Rarity.ToString()
                                        </MudChip>
                                        
                                        @if (product.Probability > 0)
                                        {
                                            <MudChip T="string" Color="Color.Secondary" Size="Size.Small">
                                                <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" Class="mr-1" />
                                                Online
                                            </MudChip>
                                        }
                                    </div>
                                </div>
                                <div class="pa-3 d-flex flex-column flex-grow-1">
                                    <MudText Typo="Typo.subtitle1" Class="text-truncate">@product.Name</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Primary" Class="mt-auto pt-2 font-weight-bold">@FormatPrice(product.CurrentPrice)</MudText>
                                </div>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            </div>
        }
    }
</MudContainer>

<!-- Try Your Luck Dialog -->
<MudDialog @bind-IsVisible="_gachaDialogVisible" Options="_dialogOptions" DisableSidePadding="true">
    <DialogContent>
        @if (_isProcessing)
        {
            <div class="d-flex flex-column align-center py-8">
                <MudProgressCircular Color="Color.Secondary" Indeterminate="true" Size="Size.Large" />
                <MudText Class="mt-4">Đang xử lý yêu cầu thanh toán...</MudText>
            </div>
        }
        else
        {
            <div class="pa-4 position-relative">
                <div class="d-flex justify-center mb-4">
                    <MudImage Src="@(_images.FirstOrDefault() ?? "/images/box-placeholder.jpg")" 
                             Alt="@(BlindBox?.Name)" Width="200" Height="200" ObjectFit="ObjectFit.Contain" />
                </div>
                
                <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4 font-weight-bold">@BlindBox.Name</MudText>

                @if (BlindBox.Probability > 0)
                {
                    <div class="mb-4">
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                            Online BlindBox can only be purchased one at a time
                        </MudAlert>
                    </div>
                }

                <div class="d-flex flex-column gap-2 mb-4">
                    <div class="d-flex justify-space-between align-center">
                        <MudText>Giá:</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="font-weight-bold">
                            @FormatPrice(BlindBox.CurrentPrice)
                        </MudText>
                    </div>
                    
                    <div class="d-flex justify-space-between align-center">
                        <MudText>Phí vận chuyển:</MudText>
                        <MudText Typo="Typo.body1">@FormatPrice(20000)</MudText>
                    </div>
                    
                    <MudDivider Class="my-2" />
                    
                    <div class="d-flex justify-space-between align-center">
                        <MudText>Tổng cộng:</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="font-weight-bold">
                            @FormatPrice(BlindBox.CurrentPrice + 20000)
                        </MudText>
                    </div>
                </div>
                
                <MudText Typo="Typo.subtitle1" Class="font-weight-medium mt-6 mb-3">Địa chỉ giao hàng</MudText>
                
                <div class="d-flex flex-column gap-3">
                    <div class="d-flex gap-3">
                        <MudTextField @bind-Value="_firstName" Label="Họ" Variant="Variant.Outlined" FullWidth="true" />
                        <MudTextField @bind-Value="_lastName" Label="Tên" Variant="Variant.Outlined" FullWidth="true" />
                    </div>
                    
                    <MudTextField @bind-Value="_address" Label="Địa chỉ" Variant="Variant.Outlined" />
                    
                    <div class="d-flex gap-3">
                        <MudTextField @bind-Value="_province" Label="Tỉnh/Thành phố" Variant="Variant.Outlined" FullWidth="true" />
                        <MudTextField @bind-Value="_ward" Label="Quận/Huyện" Variant="Variant.Outlined" FullWidth="true" />
                    </div>
                    
                    <MudTextField @bind-Value="_phone" Label="Số điện thoại" Variant="Variant.Outlined" />
                    
                    <MudCheckBox @bind-Checked="_acceptTerms" T="bool" Label="Tôi hiểu rằng kết quả BlindBox là ngẫu nhiên và không được hoàn tiền" Color="Color.Secondary" Class="mt-2" />
                </div>
                
                <div class="d-flex justify-center mt-6">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary"
                              Size="Size.Large"
                              StartIcon="@Icons.Material.Filled.Payment"
                              FullWidth="true"
                              OnClick="ProcessGachaWithVNPay" 
                              Disabled="@(!_acceptTerms || _isProcessing)">
                        Nhấn để thanh toán
                    </MudButton>
                </div>
                
                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                             Color="Color.Default" 
                             Size="Size.Small"
                             Class="position-absolute" 
                             Style="top: 8px; right: 8px;" 
                             OnClick="CloseGachaDialog" />
            </div>
        }
    </DialogContent>
</MudDialog>

<!-- Gacha Result Dialog -->
<MudDialog @bind-IsVisible="_gachaResultDialogVisible" Options="_resultDialogOptions" DisableSidePadding="true">
    <DialogContent>
        @if (!_isGachaAnimationComplete)
        {
            <div class="d-flex flex-column align-center py-8 px-6">
                <div class="position-relative" style="width: 280px; height: 280px; overflow: hidden; border-radius: 8px; box-shadow: 0 0 15px rgba(103, 58, 183, 0.2);">
                    <MudImage Src="@(_animationImages.ElementAtOrDefault(_currentAnimationIndex) ?? _images.FirstOrDefault() ?? "/images/box-placeholder.jpg")"
                              Class="w-100 h-100 object-contain" Style="transition: all 0.05s ease-in-out; transform: scale(1.05);" />
                    <div class="position-absolute inset-0" style="background: radial-gradient(circle, transparent 70%, rgba(103, 58, 183, 0.1) 100%);"></div>
                </div>
                <MudProgressLinear Indeterminate="true" Color="Color.Secondary" Class="my-4" />
                <MudText Typo="Typo.body1">Rolling your luck...</MudText>
                <MudText Typo="Typo.caption" Class="mt-2 text-center">Finding your special item from the collection...</MudText>
            </div>
        }
        else if (_resultItem != null)
        {
            <div class="d-flex flex-column align-center py-8 px-6 text-center">
                <MudIcon Icon="@Icons.Material.Filled.Celebration" Color="Color.Secondary" Size="Size.Large" Class="mb-4" />
                <MudText Typo="Typo.h4" Class="mb-4">Congratulations! 🎉</MudText>
                
                <div class="position-relative mb-6" style="width: 280px; height: 280px;">
                    <MudImage Src="@_resultItem.ImageUrl" Alt="@_resultItem.Name" 
                             Class="w-100 h-100 object-contain rounded-lg" 
                             Style="box-shadow: 0 0 15px rgba(103, 58, 183, 0.4);" />
                    
                    <MudChip T="string" Color="@GetItemRarityColor(_resultItem.Rarity)" Size="Size.Large" 
                            Class="position-absolute font-weight-bold px-3" 
                            Style="top: 10px; right: 10px;">
                        @GetRarityText(_resultItem.Rarity)
                    </MudChip>
                </div>
                
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-2">@_resultItem.Name</MudText>
                <MudText Typo="Typo.body1" Class="mb-6">@_resultItem.Description</MudText>
                
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Success" 
                          EndIcon="@Icons.Material.Filled.CheckCircle" 
                          Size="Size.Large"
                          Class="px-6 py-2"
                          OnClick="CloseResultDialog">
                    Claim My Prize
                </MudButton>
            </div>
        }
    </DialogContent>
</MudDialog>

<!-- Item Preview Dialog -->
<MudDialog @bind-IsVisible="_itemPreviewVisible" Options="new DialogOptions { CloseButton = true, FullWidth = true, MaxWidth = MaxWidth.Medium }">
    <TitleContent>
        <MudText Typo="Typo.h6" Class="pa-3">@(_selectedItem?.Name ?? "Chi tiết vật phẩm")</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedItem != null)
        {
            <div class="d-flex flex-column align-items-center">
                <div class="position-relative mb-4" style="width: 100%; max-width: 300px;">
                    <MudImage Src="@_selectedItem.ImageUrl" Alt="@_selectedItem.Name" 
                             ObjectFit="ObjectFit.Contain" Style="max-height: 300px; width: 100%;" 
                             Class="rounded-lg" Loading="true" />
                             
                    <MudChip T="string" Color="@GetItemRarityColor(_selectedItem.Rarity)" Size="Size.Medium" 
                            Class="position-absolute" Style="top: 10px; right: 10px;">
                        @GetRarityText(_selectedItem.Rarity)
                    </MudChip>
                </div>
                
                <MudText Typo="Typo.h6" Class="mb-2 text-center">@_selectedItem.Name</MudText>
                
                <MudDivider Class="my-3" />
                
                <MudText Typo="Typo.body1" Class="mb-3 text-center px-3">
                    @_selectedItem.Description
                </MudText>
                
                @if (_selectedItem.IsSecret)
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Star" Class="mb-3 mt-2">
                        Đây là vật phẩm bí mật với tỷ lệ xuất hiện thấp!
                    </MudAlert>
                }
                
                <MudPaper Elevation="0" Class="pa-3 mt-2 rounded-lg w-100" Style="background-color: rgba(0,0,0,0.02);">
                    <MudText Typo="Typo.caption" Class="d-flex align-center justify-center">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                        Mỗi BlindBox chỉ có thể nhận được một vật phẩm.
                    </MudText>
                </MudPaper>
            </div>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseItemPreview" Color="Color.Primary">Đóng</MudButton>
    </DialogActions>
</MudDialog>

<!-- Simple Image Preview -->
<MudOverlay @bind-Visible="_imagePreviewVisible" DarkBackground="true" ZIndex="999" OnClick="CloseImagePreview">
    <div class="d-flex justify-center align-items-center" style="height: 100vh;" @onclick:preventDefault>
        <div class="position-relative" style="width: 90%; max-width: 1200px; max-height: 90vh; overflow: auto;">
            <MudCard Class="pa-4 position-relative" Style="background-color: rgba(0,0,0,0.8);">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Surface">Xem chi tiết hình ảnh</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Surface" OnClick="CloseImagePreview" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="d-flex flex-column align-center justify-center">
                    <div class="result-image-container @($"{(_isZoomed ? "zoomed" : "")}")">
                        <MudImage Src="@_selectedImage" 
                               Alt="Image Preview"
                               Class="result-image rounded-lg" 
                               ObjectFit="ObjectFit.Contain"
                               @onclick="ToggleZoom" />
                    </div>
                    
                    @if (_images.Count > 1)
                    {
                        <div class="d-flex align-center justify-center mt-4 gap-2">
                            <MudIconButton Icon="@Icons.Material.Filled.NavigateBefore" Color="Color.Surface" 
                                         OnClick="() => NavigatePreviewImage(-1)" />
                            
                            <MudText Typo="Typo.body2" Color="Color.Surface" Class="mx-2">
                                @(_images.IndexOf(_selectedImage) + 1) / @_images.Count
                            </MudText>
                            
                            <MudIconButton Icon="@Icons.Material.Filled.NavigateNext" Color="Color.Surface" 
                                         OnClick="() => NavigatePreviewImage(1)" />
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        </div>
    </div>
</MudOverlay>

<style>
    .mud-tabs-panels {
        padding: 16px;
    }
    
    .gacha-animation-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 20px auto;
    }
    
    .gacha-item {
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0;
        transform: scale(0.8);
        transition: opacity 0.1s, transform 0.1s;
    }
    
    .gacha-item.active {
        opacity: 1;
        transform: scale(1);
    }

    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.2);
        opacity: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 0.3s ease;
        border-radius: 8px;
    }

    .image-overlay:hover {
        opacity: 1;
    }

    .thumbnail-preview {
        width: 50px;
        height: 50px;
        cursor: pointer;
        opacity: 0.6;
        transition: all 0.2s;
        border: 2px solid transparent;
    }

    .thumbnail-preview:hover {
        opacity: 0.8;
    }

    .thumbnail-preview.active {
        opacity: 1;
        border-color: var(--mud-palette-primary);
    }

    .item-image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.3);
        opacity: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 0.2s ease;
        border-radius: 50%;
        cursor: zoom-in;
    }

    .item-image-overlay:hover {
        opacity: 1;
    }

    .image-zoom-container {
        position: relative;
        overflow: hidden;
        width: 100%;
        cursor: zoom-in;
    }

    .zoom-image {
        transition: transform 0.3s ease;
        width: 100%;
        display: flex;
        justify-content: center;
        cursor: zoom-in;
    }

    .zoom-image.zoomed {
        transform: scale(1.5);
        cursor: zoom-out;
    }

    .result-image-container {
        width: 280px;
        height: 280px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: transparent;
        border-radius: 8px;
        transition: transform 0.3s ease;
        cursor: zoom-in;
    }
    
    .result-image-container.zoomed {
        transform: scale(1.5);
        cursor: zoom-out;
    }
    
    .result-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        width: 100%;
        height: 100%;
    }
</style> 